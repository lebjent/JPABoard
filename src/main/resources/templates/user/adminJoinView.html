<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http://www.ultraq.net.nz/thymeleaf/layout
      layout:decorate="~{layouts/layoutBasic}">
      
    	<th:block layout:fragment="css">
			<style>
				.content{
					height: 800px;
				}
				.join-form{
					width: 600px;
					margin: 0 auto;
				}
				.form-label{
					font-size: 15pt;
					font-weight: bold;
				}
				
				.btn-group{
					float:right;
					margin: auto;
					margin-top: 50px;
					width: 100px;
				}
				
				#user_id{
					width: 400px;
				}
				
				.fieldError{
					color: red;
					font-size: 11pt;
					font-weight: bold;
				}
				
			</style>
		</th:block> 
      	<th:block layout:fragment="script">
      		<script type="text/javascript">
				$(document).ready(function(){
					//모달실행시 화면밖을 클리시 닫히는 경우를 방지 하기위하여
					$('#chkModal').modal({backdrop: 'static', keyboard: false}) ;
					
					$('.close').click(function(e){
						e.preventDefault();
						$('#chkModal').modal("hide");
					});
					
					$('#close_btn').click(function(e){
						e.preventDefault();
						$('#chkModal').modal("hide");
					});
					
					/* 중복확인 창 아이디 사용하기 버튼 */
					$('#use_btn').on("click",function(e){
						e.preventDefault();
						$('#chkModal').modal("hide");
						$('#user_id').attr("readonly",true);
						$('#dupe_chk').val("Y");
						
					});
					/* 중복확인 버튼 클릭시 실행 */
					$("#dupe_btn").on("click",function(){
						dupChk();
					})
					
					/* 회원가입 버튼 클릭시 실행 */
					$("#join_btn").on("click",function(){
						userJoin(); 
					})
					/* 숫자말고 다른문자 입력시 지워지는 이벤트 */
				   $("#phone").on("keyup", function() {
				      $(this).val($(this).val().replace(/[^0-9]/g,""));
				   });
					
				})
				
				/* 중복확인 Ajax 통신 */
				function dupChk(){
					
					let userId = $("#user_id").val();
					let dupe_chk = $("#dupe_chk").val();
					$("#chk_msg").html("");//아이디 밑에 초기화.
					
					//스프링 시큐리티를 사용할경우 POST로 보낼시에는 보안을 위해 무조권 csrf를 체크한다.
					var header = $("meta[name='_csrf_header']").attr('content');
					var token = $("meta[name='_csrf']").attr('content');
					
					
					if(dupe_chk == "Y"){
						$("#chk_msg").html("이미 중복확인을 완료하였습니다.");
						return false;
					}
					
					if(userId == ""){
						$("#chk_msg").html("아이디를 입력해주세요.");
						return false;
					}
					$.ajax({
						url:"/user/dupeChk",
						type:"post",
						dataType:"json",
						data:{"userId":$("#user_id").val()},
						async:true,
					    beforeSend: function(xhr){
					        xhr.setRequestHeader(header, token);
					    },
						success:function(data){
							if(data.status == "OK"){
								modalAlert(data.status);
							}else if(data.status =="FAIL"){
								modalAlert(data.status);
							}
						}
					})
				}
				/* 회원가입 타입에 따른 Modal알림창 */
				function modalAlert(type){
					//모달창 오픈
					$('#chkModal').modal("show");
					
					/* 요소 초기화 */
					$("#use_btn").hide();
					$("#close_btn").hide();
					$("#modal-body").empty();
					
					//모달창 타이틀
					$("#chkTitle").html("중복확인 체크");
					
					let msg = "";
					if(type == "OK"){
						msg = "사용가능한 아이디입니다.";
						$("#use_btn").show();
					}else if("FAIL"){
						msg = "이미 가입된 아이디입니다.";
						$("#close_btn").show();
					}
					//모달창 내용
					$("#modal-body").append("<span style='font-weight: bold;'>"+msg+"</span>");
				}
				
				/* form 태그로 회원가입 */
				function userJoin(){
					
					/* 초기화 */
					$("#name_msg").html('');
					$("#chk_msg").html('');
					$("#pw_msg").html('');
					$("#phone_msg").html('');
					
					let dupe_chk = $('#dupe_chk').val(); //중복완료 체크
					let name = $('#name').val();//이름 체크
					let user_id = $("#user_id").val();//아이디 체크
					let password = $('#password').val(); //비밀번호 체크
					let phone = $('#phone').val(); //전화번호 체크
					
					if(name == ""){
						$("#name_msg").html('이름을 입력해주세요.');
						return false;
					}
					
					if(name.length >= 5){
						$("#name_msg").html('이름을 4자이내로 입력해주세요.');
						return false;
					}
					
					if(dupe_chk =="N"){
						$("#chk_msg").html('아이디 중복확인을 해주세요.');
						return false;
					}
					
					if(password==""){
						$("#pw_msg").html('비밀번호를 입력해주세요.');
						return false;
					}
					
					if(password.length < 4 ||password.length >= 12){
						$("#pw_msg").html('비밀번호를 4자이상 12자 이하로 입력해주세요.');
						return false;
					}
					
					if(phone == "" ){
						$("#phone_msg").html('휴대전화번호를 입력해주세요.');
						return false;
					}
					
					if(phone.length != 11){
						$("#phone_msg").html('휴대전화번호를 11자리로 입력해주세요');
						return false;
					}
					
					/* 유효성 검사가 끝나면 가입 */
					$("#adminJoinForm").submit();
				}
				
			</script>
      	</th:block>
    <div layout:fragment="content">
    	<div class="py-5 text-center">
      		<img class="d-block mx-auto mb-4" th:src="@{/img/admin.png}" alt="" width="125" height="125">
      		<h2>관리자 회원가입</h2>
   	 	</div>
   	 	<form action="/user/join" role="form" method="post" id="adminJoinForm" th:object="${userFormDTO}">
   	 	<div class="join-form">
	 		<div class="col-12">
              <label for="name" class="form-label">이름<span class="text-muted">(Name)</span></label>
              <input type="text" class="form-control" id="name" th:field="*{name}" placeholder="이름을 입력하세요.">
	          <p id="name_msg" class="fieldError"></p>
            </div>
   	 		<div class="col-12">
              <label for="user_id" class="form-label">아이디<span class="text-muted">(Id)</span></label>
         	  <div class="input-group">
	            <input type="text" id="user_id" th:field="*{userId}" class="form-control" placeholder="아이디를 입력하세요.">
	            <input type="hidden" id="dupe_chk" value="N" >
	            <button type="button" class="btn btn-secondary" id="dupe_btn">중복확인</button>
	            <p id="chk_msg" class="fieldError"></p>
	          </div>
            </div>
            <div class="col-12">
              <label for="password" class="form-label">비밀번호<span class="text-muted">(Password)</span></label>
              <input type="password" class="form-control" id="password" th:field="*{password}" placeholder="비밀번호를 입력하세요.">
	          <p id="pw_msg" class="fieldError"></p>
            </div>
            <div class="col-12">
              <label for="phone" class="form-label">휴대전화번호<span class="text-muted">(Phone)</span></label>
              <input type="text" class="form-control" id="phone" th:field="*{phone}" placeholder="-없이 휴대 전화번호를 입력해주세요.">
	          <p id="phone_msg" class="fieldError"></p>
            </div>
            <input type="hidden" id="role" name="role" value="ADMIN" >
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="btn-group">
            	<button class="btn btn-lg btn-danger" type="button" id="join_btn" >가입</button>
            </div>
        </div>
		</form>
		<!-- 알림 모달 창 -->
		<div class="modal fade" id="chkModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="chkTitle"></h5>
		        <div class="close" data-dismiss="modal" aria-label="Close">
		          <img  th:src="@{/img/close.png}">
		        </div>
		      </div>
		      <div class="modal-body" id="modal-body">
		      </div>
		      <div class="modal-footer" id="modal-footer">
		      		<button type='button' id="close_btn" class='btn btn-secondary'>닫기</button>
		      		<button type='button' id="use_btn" class='btn btn-primary'>아이디 사용하기</button>
		      </div>
		    </div>
		  </div>
		</div>
   	 </div>
</html>