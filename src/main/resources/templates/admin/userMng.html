<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http://www.ultraq.net.nz/thymeleaf/layout
      layout:decorate="~{layouts/layoutBasic}">
    
    	    	<th:block layout:fragment="css">
    		<style>
				
				.user-main{
					margin:0 auto;
					margin-top:50px;
					width: 900px;
				}
				
				table{
					margin-top: 40px;
				}
				
				tr{
					text-align: center;
				}
				
				td{
					text-align: center;
					vertical-align: middle;
				}
				
				.userSearch{
					margin-bottom: 20px;
				}
				
				#modal-correct{
					width: 500px;
				}
				
				.fieldError{
					color: red;
					font-size: 11pt;
					font-weight: bold;
				}
				
			</style>
    	</th:block> 
      	<th:block layout:fragment="script">
      		<script type="text/javascript">
				$(document).ready(function(){
					
					$('#withDrawModal').modal({backdrop: 'static', keyboard: false}) ;
					$('#correctModal').modal({backdrop: 'static', keyboard: false}) ;
					
					//search_btn클릭시
					$("#search_btn").on("click",function(e){
						e.preventDefault();
						page(0);
					})
					//회원탈퇴 버튼 클릭시
					$("button[name='withDraw_btn']").on("click",function(){
						let uno = $(this).data("uno");
						let userId = $(this).data("userid");
						
						modalConfirm(function(confirm){
							  if(confirm){
								  withDrawUser(uno,userId);
							  }else{
								return false;
							  }
						});
						
					})
					
					//정보수정 버튼클릭시
					$("button[name='info_correct_btn']").on("click",function(){
						$("#correctModal").modal('show');
						let uno = $(this).data("uno");
						getUser(uno);
					})
					
					//수정모달 컨트롤러
					correctModalControl();
					
					//회원수정 버튼 클릭시
					$("#correct_btn").on("click",function(){
						userModify();
					})
				})
				
				//회원탈퇴
				function withDrawUser(uno,userId){
					location.href="/admin/userWithDraw?uno="+uno+"&userId="+userId;
				}
				
				//페이지 이동 및 검색 기능
				function page(page){
					let searchType = $("#searchType").val();
					let keyword = $("#keyword").val();
					location.href = "/admin/userMng/"+page+"?searchType="+searchType+"&keyword="+keyword;
				}
				
				/* Modal콜백 함수 */
				function modalConfirm(callback){
					//모달창 열기
					$("#withDrawModal").modal('show');
					
					$("#confirm_btn").on("click",function(e){
						e.preventDefault();
						$('#withDrawModal').modal("hide");
						callback(true);
					})
					
					$('#cancel_btn').click(function(e){
						callback(false);
						e.preventDefault();
						$('#withDrawModal').modal("hide");
					});
					
					//모달창 닫기
					$('.close').click(function(e){
						callback(false);
						e.preventDefault();
						$('#withDrawModal').modal("hide");
					});
				}
				
				//회원정보 불러오기
				function getUser(uno){
					
					//스프링 시큐리티를 사용할경우 POST로 보낼시에는 보안을 위해 무조권 csrf를 체크한다.
					var header = $("meta[name='_csrf_header']").attr('content');
					var token = $("meta[name='_csrf']").attr('content');
					
					$.ajax({
						url:"/user/getUser",
						type:"post",
						dataType:"json",
						data:{"uno":uno},
						async:true,
					    beforeSend: function(xhr){
					        xhr.setRequestHeader(header, token);
					    },
						success:function(data){
							$("#user_id").val(data.userId);
							$("#name").val(data.name);
							$("#phone").val(data.phone);
							$("#uno").val(data.uno);
						}
					})
					
				}
				
				/* 회원정보수정창 모달 컨트롤 */
				function correctModalControl(){
					$("#exit_btn").on("click",function(){
						$("#correctModal").modal('hide');
					})
					
					$(".exit").on("click",function(){
						$("#correctModal").modal('hide');
					})
					
				   /* 숫자말고 다른문자 입력시 지워지는 이벤트 */
				   $("#phone").on("keyup", function() {
				      $(this).val($(this).val().replace(/[^0-9]/g,""));
				   })
					
				}
				
				//회원정보 수정 유효성체크 및 회원수정 진행
				function userModify(){
					let password = $('#password').val(); //비밀번호 체크
					let phone = $('#phone').val(); //전화번호 체크
					
					if(password==""){
						$("#pw_msg").html('비밀번호를 입력해주세요.');
						return false;
					}
					
					if(password.length < 4 ||password.length >= 12){
						$("#pw_msg").html('비밀번호를 4자이상 12자 이하로 입력해주세요.');
						return false;
					}
					
					if(phone == "" ){
						$("#phone_msg").html('휴대전화번호를 입력해주세요.');
						return false;
					}
					
					if(phone.length != 11){
						$("#phone_msg").html('휴대전화번호를 11자리로 입력해주세요');
						return false;
					}
					
					$("#modifyForm").submit();
					
				}
				
			</script>
      	</th:block>
    <div layout:fragment="content">
    	<div class="user-main" th:object="${userList}">
    		<h3>JPA 회원관리</h3>
		<div class="userSearch d-flex  align-items-center" th:object="${userSearchDTO}" style="float: right;">
           	<select class="form-select" th:field="*{searchType}" id="searchType" style="margin-right: 15px; width: 150px;">
				  <option value="N">이름</option>
				  <option value="I">아이디</option>
				  <option value="P">내용</option>
				  <option value="NI">이름+아이디</option>
			</select>
			<input type="text" class="form-control" th:field="*{keyword}" id="keyword"  placeholder="검색어를 입력해주세요." style="width: 250px;">
	        <a class="link-secondary" id="search_btn" aria-label="Search">
	          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="mx-3" role="img" viewBox="0 0 24 24"><title>Search</title><circle cx="10.5" cy="10.5" r="7.5"></circle><path d="M21 21l-5.2-5.2"></path></svg>
	        </a>
      	</div>  
    		<table class="table table-Secondary table-striped table-hover">
	          <thead>
	            <tr>
	              <th scope="col">번호</th>
	              <th scope="col">이름</th>
	              <th scope="col">아이디</th>
	              <th scope="col">전화번호</th>
	              <th scope="col">가입일</th>
	              <th scope="col">관리</th>
	            </tr>
	          </thead>
	          <tbody>
	            <tr th:each="user, status:${userList.getContent()}">
	              <td th:text="${user.uno}"></td>
	              <td th:text="${user.name}"></td>
	              <td th:text="${user.userId}"></td>
	              <td th:text="${user.phone}"></td>
	              <td th:text="${#temporals.format(user.joinDate, 'yyyy-MM-dd')}"></td>
	              <td>
	              	<button type="button" th:text="정보수정" th:data-uno="${user.uno}" name="info_correct_btn" class='btn btn-success'></button>
	              	<span style="font-weight: bold;">/</span>
	              	<button type="button" th:text="회원탈퇴" th:data-uno="${user.uno}" th:data-userid="${user.userId}" name="withDraw_btn" class='btn btn-danger'></button>
	              </td>
	            </tr>
	           	<tr th:if="${userList.isEmpty()}">
	              <td colspan="6">검색조건에 따른 결과가 없습니다.</td>
	            </tr>
	          </tbody>
        	</table>
	        <nav aria-label="Page navigation example" th:with="start=${(userList.number/maxPage)*maxPage + 1}, end=(${(userList.totalPages == 0) ? 1 : (start + (maxPage - 1) < userList.totalPages ? start + (maxPage - 1) : userList.totalPages)})">
			  <ul class="pagination justify-content-center">
			    <li class="page-item" th:classappend="${userList.first}?'disabled'">
			      <a class="page-link" th:onclick="'javascript:page(' + ${userList.number - 1} + ')'" aria-label="Previous">
			        <span aria-hidden="true">&laquo;</span>
			      </a>
			    </li>
			    <li class="page-item" th:each="page: ${#numbers.sequence(start, end)}" th:classappend="${userList.number eq page-1}?'active':''">
			    	<a class="page-link" th:onclick="'javascript:page(' + ${page - 1} + ')'" th:inline="text" >[[${page}]]</a>
			    </li>
			    <li class="page-item" th:classappend="${userList.last}?'disabled'">
			      <a class="page-link" th:onclick="'javascript:page(' + ${userList.number + 1} + ')'" aria-label="Next">
			        <span aria-hidden="true">&raquo;</span>
			      </a>
			    </li>
			  </ul>
			</nav>
    	</div>
    	
    	<!-- 회원탈퇴 컨펌 모달 창 -->
		<div class="modal fade" id="withDrawModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="confirmTitle">※주의</h5>
		        <div class="close" data-dismiss="modal" aria-label="Close">
		          <img  th:src="@{/img/close.png}">
		        </div>
		      </div>
		      <div class="modal-body" id="modal-confirm">
		      	<p style="font-weight: bold; font-size: 10pt;">회원탈퇴시 게시물도 삭제 됩니다.</p>
		      	<p style="font-weight: bold; font-size: 10pt;">그래도 정말로 탈퇴하시겠습니까?</p>
		      </div>
		      <div class="modal-footer" id="modal-footer">
		      		<button type='button' id="confirm_btn" class='btn btn-danger'>탈퇴</button>
		      		<button type='button' id="cancel_btn" class='btn btn-secondary'>취소</button>
		      </div>
		    </div>
		  </div>
		</div>
    	
    	<!-- 회원 정보수정 모달 창 -->
    	<form id="modifyForm" action="/user/userModify" method="post">
		<div class="modal fade" id="correctModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		  <meta name="_csrf" th:content="${_csrf.token}">
		  <meta name="_csrf_header" th:content="${_csrf.headerName}">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="confirmTitle">회원정보수정</h5>
		        <div class="exit" data-dismiss="modal" aria-label="Close">
		          <img  th:src="@{/img/close.png}">
		        </div>
		      </div>
		      <div class="modal-body" id="modal-correct">
			 		<div class="col-12">
		              <label for="name" class="form-label">이름<span class="text-muted">(Name)</span></label>
		              <input type="text" class="form-control" id="name" placeholder="이름을 입력하세요." disabled>
			          <p id="name_msg" class="fieldError"></p>
		            </div>
		   	 		<div class="col-12">
		              <label for="user_id" class="form-label">아이디<span class="text-muted">(Id)</span></label>
		         	  <div class="input-group">
			            <input type="text" id="user_id"  class="form-control" placeholder="아이디를 입력하세요." disabled>
			          </div>
		            </div>
		            <div class="col-12">
		              <label for="password" class="form-label">비밀번호<span class="text-muted">(Password)</span></label>
		              <input type="password" class="form-control" id="password" name="password"  placeholder="비밀번호를 입력하세요.">
			          <p id="pw_msg" class="fieldError"></p>
		            </div>
		            <div class="col-12">
		              <label for="phone" class="form-label">휴대전화번호<span class="text-muted">(Phone)</span></label>
		              <input type="text" class="form-control" id="phone" name="phone"  placeholder="-없이 휴대 전화번호를 입력해주세요.">
			          <p id="phone_msg" class="fieldError"></p>
		            </div>
		            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
		            <input type="hidden" name="uno" id="uno">
		      </div>
		      <div class="modal-footer" id="modal-footer">
		      		<button type='button' id="correct_btn" class='btn btn-success'>수정</button>
		      		<button type='button' id="exit_btn" class='btn btn-secondary'>취소</button>
		      </div>
		    </div>
		  </div>
		</div>
		</form>
  	</div>
</html>