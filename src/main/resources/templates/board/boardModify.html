<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http://www.ultraq.net.nz/thymeleaf/layout
      layout:decorate="~{layouts/layoutBasic}">
    
    	<th:block layout:fragment="css">
    		<style>
				.board-content{
					margin: 0 auto;
					margin-top: 80px;
					width: 800px;
				}
				
				.form-select{
					width: 140px;
					float: right;
				}
				
				.btn-group{
					float: right;
					margin-top: 30px;
				}
				
			</style>	
    	</th:block> 
      	<th:block layout:fragment="script">
      		<script type="text/javascript">
				$(document).ready(function(){
					//첨부파일 유효성 체크
					bindDomEvent();
					
					//모달실행시 화면밖을 클리시 닫히는 경우를 방지 하기위하여
					$('#chkModal').modal({backdrop: 'static', keyboard: false}) ;
					
					$('#confirmModal').modal({backdrop: 'static', keyboard: false}) ;
					
					//모달창 닫기
					$('.close').click(function(e){
						e.preventDefault();
						$('#chkModal').modal("hide");
					});
					
					//모달창 닫기
					$('#close_btn').click(function(e){
						e.preventDefault();
						$('#chkModal').modal("hide");
					});
					
					//게시판 수정
					modalConfirm(function(confirm){
						  if(confirm){
							  boardModify();
						  }else{
							return false;
						  }
					});
					
					
				})
				
				//게시물 작성시 유효성 검사
				function boardModify(){
					
					let title = $("#title").val();//게시물 제목
					let writer = $("#writer").val();//작성자
					let content = $("#content").val();//게시물 제목
					let bno = $("#bno").val();//게시판 번호
					
					if(title == ''){
						modalAlert('게시물 제목을 입력해주세요.');
						return false;
					}		
					
					if(title.length >= 50){
						modalAlert('게시물 제목은 50자 이내로 입력해주세요.');
						return false;
					}	
					
					if(content == ''){
						modalAlert('게시물 내용을 입력해주세요.');
						return false;
					}	
					
					if(title.length >= 200){
						modalAlert('게시물 내용은 200자 이내로 입력해주세요.');
						return false;
					}	
					
					$("#boardForm").attr("action","/board/boardModify/"+bno);
					$("#boardForm").submit();
				}
				
				//파일 확장자명 체크
				function bindDomEvent(){
						$("input[name='boardFile']").on("change",function(){
							//파일명
							let fileName = $(this).val().split("\\").pop();
							//파일 확장자명
							let fileExt = fileName.substring(fileName.lastIndexOf(".")+1);
							
							if(fileExt != "jpg" && fileExt != "jpeg" && fileExt != "gif" && fileExt != "png" 
									&& fileExt != "bmp" && fileExt != "xlsx" && fileExt != "xlsx" && fileExt != "pptx"){
								
								//모달 알림창 
								modalAlert('해당 확장자는 첨부가 불가능 합니다.');
								
								$(this).val('');//첨부파일 초기화
								
								return false;
							}
							
						})				
				}
      			
				/* Modal콜백 함수 */
				function modalConfirm(callback){
					
					 $("#modify_btn").on("click", function(e){
						 e.preventDefault();
						 $("#confirmModal").modal('show');
					 });
					
					$("#confirm_btn").on("click",function(e){
						e.preventDefault();
						$('#confirmModal').modal("hide");
						callback(true);
					})
					
					$('#cancel_btn').click(function(e){
						callback(false);
						e.preventDefault();
						$('#confirmModal').modal("hide");
					});
					
					//모달창 닫기
					$('.close').click(function(e){
						callback(false);
						e.preventDefault();
						$('#confirmModal').modal("hide");
					});
				}
				
				/* 기본 Modal알림창 */
				function modalAlert(msg,type){
					//모달창 오픈
					$('#chkModal').modal("show");
					
					/* 요소 초기화 */
					$("#modal-body").empty();
					
					//모달창 타이틀
					$("#chkTitle").html("알림");
					
					//모달창 내용
					$("#modal-body").append("<span style='font-weight: bold;'>"+msg+"</span>");
					
					
				}
				
			</script>
      	</th:block>
    <div layout:fragment="content">
    	<form role="form" method="post" id="boardForm" action="" enctype="multipart/form-data" th:object="${boardFormDTO}">
    	<div class="board-content">
			<div class="p-5 mb-4 bg-light rounded-3">
				<h3>JPA 프로젝트 게시판 수정</h3>
      			<div class="container-fluid py-5">
      				<div class="mb-3">
					  <label for="title" class="form-label">게시글 제목</label>
					  <input type="text" class="form-control" id="title" name="title" th:field="*{title}">
					</div>
				    <div class="row">
					    <div class="col">
					    	<div class="input-group mb-3">
  								<span class="input-group-text" id="basic-addon1">작성자</span>
  								<input type="text" class="form-control" name="writer" id="writer" th:value="${userId}" aria-label="writer" aria-describedby="basic-addon1" readonly>
							</div>
					    </div>
					    <div class="col right">
					    	<select class="form-select" name="viewStatus" th:field="*{viewStatus}" aria-label="form-select-sm example">
							  <option value="PUBLIC">전체공개</option>
							  <option value="PRIVATE">비공개</option>
							</select>
					    </div>
  					</div>
					<div class="mb-3">
					  <label for="content" class="form-label">게시글 내용</label>
					  <textarea class="form-control" id="content" name="content" th:field="*{content}" rows="8"></textarea>
					</div>
					<div th:if = "${not #lists.isEmpty(boardFormDTO.boardFileList)}">
						<div class="mb-3" th:each="boardFileDTO,status: ${boardFormDTO.boardFileList}">
						  <div>
						  	<label for="boardFile" class="form-label" th:text="첨부파일 + ${status.count}"></label>
						  	<input class="form-control form-control-sm" id="boardFile" name="boardFile" type="file">
						  	<input type="hidden" name="boardFileFno" th:value="${boardFileDTO.fno}">
						  </div>
						</div>
					</div>
					<input type="hidden" name="bno" id="bno" th:value="${boardFormDTO.bno}">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
					<div class="btn-group right">
						<button type="button" id="modify_btn" class="btn btn-primary">수정</button>
					</div>
      			</div>
      		</div>	
    	</div>
    	</form>
 		<!-- 컨펌 모달 창 -->
		<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="confirmTitle">※주의</h5>
		        <div class="close" data-dismiss="modal" aria-label="Close">
		          <img  th:src="@{/img/close.png}">
		        </div>
		      </div>
		      <div class="modal-body" id="modal-confirm">
		      	<p style="font-weight: bold; font-size: 10pt;">기존의 첨부파일은 삭제됩니다.</p>
		      	<p style="font-weight: bold; font-size: 10pt;">그래도 정말로 수정하시겠습니까?</p>
		      </div>
		      <div class="modal-footer" id="modal-footer">
		      		<button type='button' id="confirm_btn" class='btn btn-success'>확인</button>
		      		<button type='button' id="cancel_btn" class='btn btn-secondary'>취소</button>
		      </div>
		    </div>
		  </div>
		</div>
		
 		<!-- 알림 모달 창 -->
		<div class="modal fade" id="chkModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="chkTitle"></h5>
		        <div class="close" data-dismiss="modal" aria-label="Close">
		          <img  th:src="@{/img/close.png}">
		        </div>
		      </div>
		      <div class="modal-body" id="modal-body">
		      </div>
		      <div class="modal-footer" id="modal-footer">
		      		<button type='button' id="close_btn" class='btn btn-secondary'>닫기</button>
		      </div>
		    </div>
		  </div>
		</div>
  	</div>
</html>